# Codebase Structure

## Directory Layout

```
ai_cli_preparation/
├── cli_audit.py          # Main audit engine (2,375 lines)
├── cli_audit/            # Phase 2 modular codebase
│   ├── __init__.py       # Public API exports
│   ├── common.py         # Shared types and utilities
│   ├── config.py         # Configuration management
│   ├── environment.py    # Environment detection
│   ├── package_managers.py # Package manager abstractions
│   ├── installer.py      # Core installation logic
│   ├── bulk.py           # Bulk operations
│   ├── reconcile.py      # Installation reconciliation
│   ├── upgrade.py        # Upgrade workflows
│   ├── breaking_changes.py # Breaking change detection
│   ├── install_plan.py   # Installation planning
│   └── logging_config.py # Logging configuration
├── smart_column.py       # ANSI/emoji-aware table formatter
├── scripts/              # Installation and utility scripts
│   ├── install_*.sh      # Language/tool installers (14 scripts)
│   ├── auto_update.sh    # Package manager auto-update
│   ├── guide.sh          # Interactive upgrade guidance
│   ├── upgrade_all.sh    # Bulk upgrade orchestration
│   ├── lib/              # Shared shell utilities
│   ├── installers/       # Modular installer components
│   └── AGENTS.md         # Agent-specific guidance for scripts
├── docs/                 # Comprehensive documentation (12 files)
│   ├── INDEX.md          # Documentation index by role/task
│   ├── QUICK_REFERENCE.md # One-liner command reference
│   ├── ARCHITECTURE.md   # System design and patterns
│   ├── API_REFERENCE.md  # Python API documentation
│   ├── DEVELOPER_GUIDE.md # Contribution guidelines
│   ├── TROUBLESHOOTING.md # Common issues and solutions
│   ├── PRD.md            # Product Requirements (Phase 2)
│   ├── adr/              # Architecture Decision Records
│   └── phase2_api/       # Phase 2 API specifications
├── tests/                # Test suite (growing)
├── config/               # Configuration examples
├── Makefile              # Main task automation
├── Makefile.d/           # Modular make includes
│   ├── user.mk           # User-facing commands
│   ├── dev.mk            # Development commands
│   └── maint.mk          # Maintenance commands
├── latest_versions.json  # Committed version cache (offline-first)
├── tools_snapshot.json   # Snapshot from last collect
├── pyproject.toml        # Python project metadata + tool config
├── package.json          # Node dependencies (minimal)
├── AGENTS.md             # Root agent guidance (thin, delegates to scoped)
└── README.md             # Primary user documentation
```

## Key Files and Responsibilities

### Core Audit Engine
- **cli_audit.py**: Main entry point, 50+ tool definitions, parallel execution logic
- **smart_column.py**: Table formatting with ANSI/emoji preservation
- **TOOLS**: Tuple of Tool dataclasses defining name, candidates, upstream source

### Phase 2 Modular Architecture
- **cli_audit/__init__.py**: Public API surface for programmatic use
- **cli_audit/common.py**: Shared types (InstallResult, Environment, etc.)
- **cli_audit/config.py**: YAML config loading and validation
- **cli_audit/installer.py**: Tool installation with package manager abstraction
- **cli_audit/bulk.py**: Parallel bulk install/upgrade/reconcile operations
- **cli_audit/upgrade.py**: Upgrade candidate detection and execution
- **cli_audit/breaking_changes.py**: Semver analysis for breaking changes
- **cli_audit/reconcile.py**: Duplicate installation cleanup

### Installation Scripts
- **scripts/install_python.sh**: Python via uv (preferred) or pyenv
- **scripts/install_node.sh**: Node.js via nvm (preferred) or binary
- **scripts/install_rust.sh**: Rust via rustup
- **scripts/install_core.sh**: Core tools (fd, fzf, ripgrep, jq, yq, bat, delta, just)
- **scripts/auto_update.sh**: Detect and update all package managers
- **scripts/guide.sh**: Interactive upgrade wizard with remediation

### Data Files
- **latest_versions.json**: Committed cache with manual overrides + lookup hints
- **tools_snapshot.json**: Generated by `make update`, consumed by `make audit`
- **.env**: Local environment overrides (gitignored)
- **.env.default**: Default environment variables (committed)

## Code Organization Patterns

### Tool Definition Pattern
```python
@dataclass(frozen=True)
class Tool:
    name: str                      # Display name
    candidates: tuple[str, ...]    # Executable names to search
    source_kind: str               # gh|pypi|crates|npm|gnu|skip
    source_args: tuple[str, ...]   # (owner, repo) for gh, (package,) for pypi
    category: str                  # For grouping (search, security, etc.)
    homepage: str | None           # Documentation URL
```

### Parallel Execution Pattern
```python
with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
    futures = [executor.submit(audit_tool, tool) for tool in TOOLS]
    for future in as_completed(futures):
        result = future.result()
```

### Lock Ordering Enforcement
```python
# Always acquire in this order to prevent deadlock:
with MANUAL_LOCK:       # First: manual cache lock
    with HINTS_LOCK:    # Second: hints cache lock
        # Safe update logic
```

## Module Dependencies
- cli_audit.py: Standalone, no internal imports
- cli_audit/* modules: Import from cli_audit.common, avoid circular deps
- scripts/*.sh: Source from scripts/lib/*.sh for shared utilities